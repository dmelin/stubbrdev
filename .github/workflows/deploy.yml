name: Deploy Laravel to Cloud Run

on:
    push:
        branches: [main]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Authenticate with Google Cloud
              uses: google-github-actions/auth@v1
              with:
                  credentials_json: ${{ secrets.GCP_CREDENTIALS }}

            - name: Configure Docker for Artifact Registry
              run: gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

            - name: Set up Docker
              uses: docker/setup-buildx-action@v2

            - name: Build and push image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: europe-west1-docker.pkg.dev/stubbrdev/stubbr-dev-repo/laravel-app:latest

            - name: Deploy to Cloud Run
              uses: google-github-actions/deploy-cloudrun@v1
              with:
                  service: stubbr-dev
                  image: europe-west1-docker.pkg.dev/stubbrdev/stubbr-dev-repo/laravel-app:latest
                  region: europe-west1
                  project-id: stubbrdev
                  flags: |
                      --port 8080
                      --memory 512Mi
                      --max-instances 3
                      --allow-unauthenticated